import 'dart:typed_data';
import 'dart:io';
import 'package:flutter/material.dart';
import 'package:http/http.dart' as http;
import 'package:flutter_bluetooth_printer/flutter_bluetooth_printer.dart';
import 'package:pdfx/pdfx.dart';
import 'package:path_provider/path_provider.dart';
import 'package:xhalona_pos/core/theme/theme.dart';
import 'package:xhalona_pos/widgets/app_dialog.dart';
import 'package:open_filex/open_filex.dart';

class AppPDFViewer extends StatefulWidget {
  final String pdfUrl;

  const AppPDFViewer({Key? key, required this.pdfUrl}) : super(key: key);

  @override
  _AppPDFViewerState createState() => _AppPDFViewerState();
}

class _AppPDFViewerState extends State<AppPDFViewer> {
  FlutterBluetoothPrinter bluetoothPrinter = FlutterBluetoothPrinter();
  BluetoothDevice? selectedPrinter;
  Uint8List? pdfBytes;
  Uint8List? imageBytes; // Store extracted image
  late int pageWidth; // Extracted width
  late int pageHeight; // Extracted height
  ImageProvider? pdfImage;
  PdfPageImage? pageImage;

  @override
  void initState() {
    super.initState();
    _fetchPdfBytes();
  }

  Future<void> _fetchPdfBytes() async {
    try {
      final response = await http.get(Uri.parse(widget.pdfUrl));
      if (response.statusCode == 200) {
        pdfBytes = Uint8List.fromList(response.bodyBytes);
        await _convertPdfToImage();
        setState(() {});
      } else {
        _showMessage("Failed to load PDF");
      }
    } catch (e) {
      _showMessage("Error fetching PDF: $e");
    }
  }

  // Convert PDF to Image with Dynamic Page Size
  Future<void> _convertPdfToImage() async {
    if (pdfBytes == null) return;

    final doc = await PdfDocument.openData(pdfBytes!);
    final page = await doc.getPage(1);
    pageWidth=page.width.toInt();
    pageHeight=page.height.toInt();
    double scale = 1;
    pageImage = await page.render(
        width: page.width*scale, height: page.height*scale);
    pdfImage = MemoryImage(pageImage!.bytes);
    imageBytes = pageImage!.bytes;
    await _saveImageToFile();
    await page.close();
    await doc.close();
  }

  Future<String> _saveImageToFile() async {
    try {
      final directory = await getExternalStorageDirectory();
      final imagePath = '${directory!.path}/pdf_image.png';
      final file = File(imagePath);

      await file.writeAsBytes(imageBytes!);
      _showMessage("Image saved to: $imagePath");

      return imagePath;
    } catch (e) {
      _showMessage("Error saving image: $e");
      return "";
    }
  }

  Future<void> _savePdfToDevice() async {
    if (pdfBytes == null) {
      _showMessage("PDF is not loaded yet.");
      return;
    }

    try {
      final directory =
          await getDownloadsDirectory(); // Automatically get Downloads folder
      final filePath = '${directory!.path}/downloaded.pdf';
      final file = File(filePath);

      await file.writeAsBytes(pdfBytes!);
      _showMessage("PDF saved successfully at: $filePath");
    } catch (e) {
      _showMessage("Error saving PDF: $e");
    }
  }

  // Print the converted image
  Future<void> _print() async {
    final device = await FlutterBluetoothPrinter.selectDevice(context);
    if (device != null && imageBytes != null) {
      bool success = await FlutterBluetoothPrinter.printImageSingle(
        address: device.address,
        imageWidth: pageWidth,
        imageHeight: pageHeight,
        imageBytes: imageBytes!,
        keepConnected: true,
      );

      if (success) {
        _showMessage("Printing started...");
      } else {
        _showMessage("Failed to start printing");
      }
    } else {
      _showMessage("No image data to print");
    }
  }

  void _showMessage(String message) {
    ScaffoldMessenger.of(context)
        .showSnackBar(SnackBar(content: Text(message)));
    print(message);
  }

  Future<void> _openPdfExternally() async {
    if (imageBytes != null) {
      try {
        final tempDir = await getTemporaryDirectory();
        final pdfFile = File('${tempDir.path}/temp.png');
        await pdfFile.writeAsBytes(imageBytes!);

        // Open the PDF with an external app
        await OpenFilex.open(pdfFile.path);
      } catch (e) {
        _showMessage("Error opening PDF: $e");
      }
    } else {
      _showMessage("PDF not loaded yet");
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        backgroundColor: Colors.white,
        actions: [
          IconButton(
            icon: Icon(Icons.print),
            onPressed: _print,
            tooltip: "Print to Bluetooth Thermal Printer",
          ),
          IconButton(
            icon: Icon(Icons.open_in_new),
            onPressed: _openPdfExternally,
            tooltip: "Open with External PDF Viewer",
          ),
          IconButton(
            icon: Icon(Icons.download),
            onPressed: _savePdfToDevice,
            tooltip: "Save PDF",
          ),
        ],
      ),
      body: pdfImage == null
          ? Center(
              child: AppDialog(
                  shadowColor: AppColor.blackColor,
                  content: Column(spacing: 10.h, children: [
                    Text(
                      "Tunggu Sebentar",
                      style: AppTextStyle.textSubtitleStyle(
                          color: AppColor.primaryColor),
                    ),
                    CircularProgressIndicator(
                      color: AppColor.primaryColor,
                    )
                  ])))
          : Image(
            image: pdfImage!,
          ),
    );
  }
}
