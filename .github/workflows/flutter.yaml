name: Build & Sign App

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.platform == 'android' && 'ubuntu-latest' || 'macos-latest' }}
    strategy:
      matrix:
        platform: ${{ fromJson(vars.PLATFORM) }}
    steps:
      # Ambil kode repositori
      - name: Ambil kode
        uses: actions/checkout@v4
        with:
          show-progress: true

      # Setup JDK 17 (Microsoft Distribution)
      - name: Siapkan JDK 17
        uses: actions/setup-java@v3.10.0
        with:
          distribution: 'microsoft'
          java-version: '17'

      # Install Flutter
      - name: Install Flutter
        uses: flutter-actions/setup-flutter@v4
        with:
          channel: stable
          version: 3.27.0

      # Cek versi flutter
      - name: Cek Versi Flutter
        run: flutter --version

      # Install pubspec_version_cli
      - name: Install pubspec_version_cli
        run: flutter pub global activate pubspec_version_cli

      # Cache Flutter packages
      - name: Cache Flutter Packages
        if: success()
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            !**/pubspec.lock
            build/
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      # Install dependensi flutter
      - name: Install dependencies
        run: flutter pub get

      # Manage Versioning
      - name: Manage Versioning
        id: version
        run: |
          set -e
          CURRENT_VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //;s/+.*//')
          BUILD_NUMBER=$(date +%s)
          NEW_VERSION="${CURRENT_VERSION}+$BUILD_NUMBER"
          echo "NEW_VERSION=${NEW_VERSION}" >> $GITHUB_ENV
          pubspec_version change --version "$NEW_VERSION"

      # Build based on platform
      - name: Build
        id: build
        run: |
          if [[ "${{ matrix.platform }}" == "android" ]]; then
            flutter build appbundle --release
            echo "build_path=build/app/outputs/bundle/release" >> $GITHUB_ENV
            echo "artifact_path=build/app/outputs/bundle/release/app-release.aab" >> $GITHUB_ENV
          else
            flutter build ios --release --no-codesign
            echo "build_path=build/ios/iphoneos" >> $GITHUB_ENV
            echo "artifact_path=build/ios/iphoneos/*.app" >> $GITHUB_ENV
          fi

      # Sign Android App Bundle
      - name: Sign Android App Bundle
        if: matrix.platform == 'android'
        uses: r0adkll/sign-android-release@v1.0.4
        with:
          releaseDirectory: ${{ env.build_path }}
          signingKeyBase64: ${{ secrets.KEYSTORE_BASE64 }}
          alias: ${{ secrets.KEY_ALIAS }}
          keyStorePassword: ${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_ALIAS_PASSWORD }}

      # Sign iOS App
      - name: Sign iOS App
        if: matrix.platform == 'ios'
        run: |
          security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security set-keychain-settings -t 3600 -l ~/Library/Keychains/build.keychain
          
          # Import the provisioning profile
          echo "${{ secrets.IOS_PROVISIONING_PROFILE }}" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/my_profile.mobileprovision
          
          # Import the certificate
          echo "${{ secrets.IOS_CERTIFICATE }}" | base64 --decode > certificate.p12
          security import certificate.p12 -P "${{ secrets.IOS_CERTIFICATE_PASSWORD }}" -T /usr/bin/codesign

          # Code signing
          codesign -f -s "${{ secrets.IOS_CERTIFICATE_NAME }}" --deep --timestamp --options=runtime ${{ env.build_path }}/*.app

      # Upload Artifact
      - name: Upload to Bashupload
        id: upload_bashupload
        run: |
          RESPONSE=$(curl --retry 3 --retry-delay 5 -T ${{ env.artifact_path }} https://bashupload.com/)
      
          echo "==== Response from Bashupload ===="
          
          # 1. Print normally (masked)
          echo "Upload URL (Normal): $RESPONSE"
      
          # 2. Split URL to avoid masking
          echo "Upload URL (Split): $(echo $RESPONSE | sed 's/\(http[s]*:\/\/\)/\1 /')"
      
          # 3. Encode URL in Base64 to bypass masking
          echo "Upload URL (Base64): $(echo -n "$RESPONSE" | base64)"
      
          # 4. Add a fake prefix (masking won't apply)
          echo "Upload URL (Fake Prefix): X$RESPONSE"
      
          # 5. Enable debug mode temporarily
          set -x
          echo "Upload URL (Debug Mode): $RESPONSE"
          set +x

      # Rilis Aplikasi
      - name: Rilis Aplikasi
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.NEW_VERSION }}
          files: ${{ env.artifact_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup:
    runs-on: ${{ matrix.platform == 'android' && 'ubuntu-latest' || 'macos-latest' }}
    strategy:
      matrix:
        platform: ${{ fromJson(vars.PLATFORM) }}
    needs: [build]
    if: always()
    steps:
      # Clean up
      - name: Cleanup
        if: failure()
        run: |
          if [[ "${{ matrix.platform }}" == "android" ]]; then
            rm -rf build/app/outputs/bundle/release/*.aab
          else
            rm -rf build/ios/iphoneos/*.app
          fi
